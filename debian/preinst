#!/bin/sh

set -e

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

CONFIG="/etc/apt/apt.conf.d/50unattended-upgrades"

# Retrieves (mostly user-defined) repositories in /apt/lists 
# and configures for automatic updates.
missingSources=$(python listMissingRepos.py)
for source in $missingSources; do
    sed -i "/Unattended-Upgrade::Allowed-Origins {/a \\\t$source" $CONFIG
done

dpkg-maintscript-helper rm_conffile $CONFIG 0.86.4~ -- "$@"
# if the transition to ucf was not handled properly, do it now
case "$1" in
    install|upgrade)
        if [ -n "$2" ] &&  dpkg --compare-versions "$2" lt "1.8~" \
               && dpkg-query -W  -f='${Conffiles}\n' unattended-upgrades | grep -q "$CONFIG .* obsolete"; then
	    cp "$CONFIG" "$CONFIG.ucftmp"
	    dpkg-maintscript-helper rm_conffile "$CONFIG" -- "$@"
        fi
	;;
esac
